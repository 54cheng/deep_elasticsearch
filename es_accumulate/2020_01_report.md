# 1、nestd query和bool query不能同时使用吗
使用举例：
```
{
    query:{
        bool:{
            filter:{},
            must:[{
                nested:{}
            }]
        }
    }
}
```

# 2、如何禁用 ES 模糊查询 wildcard?
我想在服务端禁止有 wildcard 查询的语句执行。ES 有这个功能吗？怎么禁止一些语句查询？比如客户端当使用 wildcard 语句查询时，服务端禁止执行这种语句。可以在服务服务端设置吗？

回复：不要直接向用户公开Elasticsearch，而是让应用程序代表用户发出请求。如果无法做到这一点，请使用一个应用程序来去除用户的请求。编写一个_search很有可能使Elasticsearch不堪重负并使集群瘫痪。所有此类搜索都应视为错误，并且Elasticsearch贡献者已尽力防止这种情况，但仍然可行。
 
这是官网文档说的，总结一下应该是说要搞一个网关，不要让可以使集群瘫痪级别的请求到达ES。在请求到达es之前过滤，而不是让es去禁止这些语句。
 
有误的地方请大神们指正

#3、使用join查询，现查询子文档，怎么返回子文档相应的父文档呢？
问题：
https://elasticsearch.cn/question/9239
使用join查询，现查询子文档，结果都是子文档，然后数据需要从子文档相应的父文档取几个字段，
问怎么返回子文档对应的父文档呢？
 
``` 
GET /my-index/_search
{
  "query": {
      "parent_id": {
          "type": "my-child",
          "id": "1"
      }
  }
}
```
回复：#4、get child document by parent document
```
GET my_index/_search
{
    "query": {
        "has_parent" : {
            "parent_type" : "question",
            "query" : {
               "match_phrase": {
                 "text": "This is a question"
               }
            },
             "inner_hits": {}   
        }
    }
}
```
# 4、elasticsearch painless 如何获取text类型的数据

本人在kibana中使用scripted fields功能，想要获取text类型的数据，进行处理。
阅读官方文档之后发现，并不能够通过doc获取text类型的数据
### 相对于其他脚本语言的一些限制：

只有数字、布尔、日期和地理点类型的字段可以被访问；
存储字段（Stored fields）不可用

求助，如何获取text类型的数据。

回复：
es 7.x
这样取可行，ES里script的语法可以参考Java
```
{
    "script" : {
      "lang" : "painless",
      "source" : """String tmpTs = ctx.things; if (0 > tmpTs.indexOf('.')) {return;}"""
    }
}
```
# 5、Elasticsearch出现周期性的慢查询

1.Elasticsearch作为搜索引擎
2.相对写少（基本都是单分片，30GB下，偶有两个索引大些，但是分片后也在30G下）
3.相对读多：总的QPS在1600+
4.一共有4台物理机作为data node，配置为24核 32GB内存 SSD盘

请教下大家为何会出现周期性的慢查询。大家是否遇到过类似情况？如何解决。

回复：
思路1：有没有开slowlog看一下你的慢查询是什么样的query呢？还有周期性出现的话，有没监控过这些个时点有没有ES的类似segment merge、GC之类的操作？
思路2：看下监控，是不是每次慢查询都在节点gc上，我目前碰到的大部分原因都在这。 还有可能是正好在缓存淘汰的时候查询直接走盘了也有可能。

#6、ES关联查询，根据结果进行二次/多次查询
小白，看了点nested和parent/child的东西，发现这个很麻烦啊，还要做映射和修改数据，没办法直接做关联查询吗？第一次查询的结果中取某个字段给参数赋值赋值，作为第二次查询的条件参数这样的
比如这个例子里面
user用户列表
```
{
"name": "John Smith",
"email": "john@smith.com",
"dob": "1970/10/24"
}
```
blog博客列表
```
{
"title": "Relationships",
"body": "It's complicated...",
"user": "John Smith"
}
```
我先根据查询条件得到一个结果user文档，其中包括name字段值，然后我根据name字段值（例子中为"John Smith" ）构建另一个查询，查询这个user的blog，类似变量赋值的概念，或者说查询结果A.name=查询结果B.user，这里可能涉及多个A结果的问题（就是说查询A可能返回很多个name，要每一个都进行B查询导致耗费大量资源）我们暂时不考虑，假定约束每次查询A都只返回少量结果）重点在于，我期望不需要先运行查询A看到结果里面的name字段再人工构建查询B，而是可以在一个查询过程里面将查询A的结果传递给查询B进行调用，这种是否可以实现？

回复：
小众应用场景：
lookup terms可以满足你要求么？
https://www.elastic.co/guide/en/elasticsearch/reference/7.5/query-dsl-terms-query.html

# 7、关于ES震荡问题是我理解的有问题吗？？？

有个问题 集群两台，索引设置分片1 副本1.，通过_stats查询出delete文档为0，使用分词查询为什么还是会出现结果震荡，但是不使用分词查询就没有问题？这是怎么回事？

medcl回复：
es 打分是分布式评分，先取局部评分TopN 在合并取 TopN，在不同节点上计算合并之后的结果是有可能存在差异，如果非常在意这个，可以使用 preference 来控制在固定的节点上进行查询。

# 8、大神们好。我想问一下身份证号码这种类型的数据，怎样才能使用模糊查询呢？在不适用wildcard的情况下有没有其它第二种方式？

阿里大佬回复：
身份证号码建议增加冗余分词字段，数据预处理，根据业务需要切分18位完整词条、前2位（省）、前4位（省市）、前6位（省市区县）、后4位、出生年月日、出生年份、出生年月、出生月日等组合。

思路2：
ngram+自定义分词

# 9、ES集群规划问题求助
各位少侠，目前我司doc大概在每天1.5个亿，存储空间的话大概是50G，doc需要保留一年，主要做doc的查询和聚合统计，现在要部署ES集群，想了解一下像这种日质量如何规划ES集群，大概需要几台机器做集群？索引、分片、副本该如何规划，请各位大侠指教。

回复1：
主要看是什么样子的聚合。
ES 集群不适合做超强大的聚合计算。要是几十万数据聚合还是可以的。
如果是大数据量数据进行聚合，那肯定不行。
这么说吧，
100台物理机，20核心cpu40线程，128gb内存，10tbSSD，在30亿条数据基础上做聚合查询，每次聚合时间几十秒甚至几分钟。
 
你这种情况：
数据量很少，如果只是小聚合，比如100W数据的集合，10台物理机应该能满足 很快的聚合效率。
ES 集合是严重消耗硬件资源的，
尤其是CPU和CPU LOAD，内存和硬盘，都还好，还有网卡的流量，能用万兆别用千兆，磁盘能用SSD别用普通的。
 
CPU 最好可以40核心，最差也要20核心。
 
能拆分成小集群，别使用一个超级大集群。
 
ES 是无法做到扩展的，一个集群是有限制的，这个限制包括内存，磁盘，存储的数据量，达到一定数量就到了瓶颈，这时候无法再扩展了。
 
拆分集群是唯一的解决方案。

回复2：
楼上大佬说的非常好了，我再补充一些，对于日志来说，一个分片最好不要超过40G的大小，50G的话最少2-3个分片吧，可以一天一个索引，副本一个就够。一年的话最好做个归档，最差也要做个冷热分离。
定期关闭索引不要一直开太多影响性能。master节点最好不要放数据，不要数据的话内存可以配小点。
如果对于要跨很多索引进行聚合的话，性能是非常差的，建议分割开进行聚合之后由拿到的结果进行二次聚合。es也有它的优劣，扬长避短，做好规范和限制。

# 10、推荐：Logstash：如何使用 Logstash 和 JDBC 确保 Elasticsearch 与关系型数据库保持同步
https://elasticstack.blog.csdn.net/article/details/103874185
