# 1、给es集群一键安装插件的方法有吗？

目前，es集群中只有三个节点，发现每次安装新的插件时，都需要手动给每个节点都安装一遍插件，觉得很繁琐，不知道有没有更好的给es集群安装插件的方式？之所以需要频繁安装es的插件，是因为发现使用es插件检索数据的性能，比使用javaAPI查询的性能快很多，所以才需要频繁开发插件来适应对时延的性能要求，导致现在每来一个业务需求都需要开发插件，然后频繁给es集群手动安装插件，觉得好繁琐，不知道有没有更好的方式？

【medcl】
可以用一些其他的工具来做，比如 Ansible，编写好 Ansible playbook，一键安装没问题

# 2、ElasticSearch查询非常缓慢

初来乍到，想请教下ES的配置推荐，现在在一个测试环境，只保存3天的日志，大概3亿条数据，查询时非常缓慢。

我的配置大概是这样的，容器化部署ES。

1. 2个data节点容器各自10G内存，其中每个data节点的jvm分了5G，剩下了5G给Lucene。data节点使用普通硬盘，并且每个节点占用空间200G左右。

2. 3个master节点各自4G内存，jvm占用2G。

3. 2个client节点，各自2G内存。

现在只是普通的查询所有的数据，在kibana上查询最近3天的数据，不添加其他任何搜索搜索条件， 每次查询都要耗时2分钟所有。
 
请问，这种情况下的数据，应该怎么样的配置更合理，另外ES方面还有没有其他优化的点。
 
另外，再附上索引的mapping，因为是对接的日志文件，又是多种类型的日志文件，比如Kubernetes日志，docker日志，普通文件的日志，所以字段较多。

经常搜索的字段，也就是message字段。不过kibana上超时的搜索，未填写任何搜索字段，仅搜索了最近3天数据，搜索也特别耗时，有时甚至会超时。

【回复】

1. Kubernetes日志，docker日志，普通文件的日志——这些日志应该放在不同的索引里，这样每次查询就只要查询对应的索引就可以了，缩小搜索范围；
2. 分片数控制在每个分片20GB以下；
3. 默认的mapping是text+keyword，手动在index_template里配合适的mapping会好很多。
4. 感觉内存给的太小了。

https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html

# 3、【function_score】ES如何实现=>需求类似：用户会员等级越高，发布的内容越优先被检索到。
[回复】

field_value_factor 结合 function_score实现

https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html

https://elasticsearch.cn/question/9926

# 4、es普通的data节点down掉，集群有1分多钟的时间不可用
】我是一个3master，2data的集群，在进行高可用的测试时，其中一个data节点down掉后，集群变得不可用，

要等三个超时时间，大概90多秒的时间，集群才能恢复正常，请问这个问题是什么原因，大家是如何解决的？

【回复】
你这种现象应该不是彻底进程挂掉，而是类似断网连接不上但是ES又没有认为该节点进程彻底死掉，所以会等三个超时时间不断去确认data节点是否存活。前端时间针对这种现象我有测试过，如果这个data节点上没有主分片的话还好，不会对写入有什么影响。

# 5、elasticsearch单索引过大问题

由于业务的发展,线上有一些累积增加的数据索引,单索引目前最大的已经有20亿的数据,目前分片5个副本1个,查询很慢,大概八九秒左右,有没有什么优化方法,比如将一个大索引分割成几个小的索引,或者增加副本数量,是否会增加查询性能.大佬们有没有好的解决办法?目前es版本5.6.9

【回复】
单个分片的索引数量，集群的总分片数，一次搜索需要处理的数据量，执行什么样的搜索语句，这些都是影响搜索性能的关键因素。

怎么处理好这些影响因素，怎么根据业务特点制定合适的索引策略，用什么样的搜索语句去获取搜索结果，这些都是需要好好考虑和好好设计的。很明显，环境中出现了这种异常索引，说明索引策略是有问题的，需要整改索引策略。

如果数据量不是很大，比如最大的索引还只有20亿条，如果这个增长是经历了很久才长上来的，那么最简单的做法是增加索引的分片，这样就可以使得每个分片的索引数量不会太大了，因为ES底层的lucene搜索时，都是针对分片维度进行的。

但是增加分片数只能针对新生成的索引，所以如果想改善旧索引的搜索性能，可以把现在的索引reindex到新的索引中（在集群比较空闲的时候做）

如果数据量增长比较快，那么简单的增加分片就无法解决查询性能问题了，就需要更精细化的索引策略了。比如数据搜索时，会携带时间维度信息，那么索引可以按天或者按月（根据数据特点来定）生成，这样搜索时先根据时间确定索引范围，然后再执行搜索，这样可以大大提高搜索性能。当然，如果数据搜索没有按天/月搜索的一些属性，比如是需要全局搜索的，这个时候索引的生成策略可以考虑在业务上做细化，比如某些业务的放在一个索引里。

如果不好按时间生成索引，也可以考虑rollover机制，这种策略就是等到数据量积累到一定程度后，再生成一个新的索引，比较适合一些时间上数据量的变化不好评估的数据。
滚动也好，按时间生成新索引也好，都是为了控制单个分片的数据量不太大。但是如果数据量大到一定程度，每次需要搜索的东西，需要匹配或处理的东西很多时，也会碰到搜索瓶颈，这时就需要根据业务特点，做更精细化的索引分配，搜索时尽量减少索引搜索范围。

总之，索引策略需要结合业务特点进行设计，简单快捷的可以考虑按时间生成新索引，按数据量rollover索引，扩大索引分片数量等

# 6、怎样查出占用cpu和内存的查询？

日志用的es集群平时基本上只提供kibana给人查日志用，grafana上有个别图表也会用到

但是因为grafana上配置了这个es的数据源，有人有权限可以看到ES地址，也不保证有人直接通过程度连接ES的可能。
 
最近看监控，经常不定期的会有一波所有节点old gc数量突然增多，有时候是突然所有节点cpu升高的情况。

但是在慢查日志里，并没有发现有用时特别长的查询，也没发现有和平时不一样的查询(也有可能混在大量的查询里我没有发现)
 
怎么样能比较有效的发现是哪个查询导致了这种情况呢，或者如果不是查询的话，还有哪些原因可能导致这种现象。有什么好的查问题的手段吗？

另外延伸出来的话题就是怎么对kibana进行管控，比如限制查询的时间范围，限制查询中设置的size过大，限制查询的频率(因为越慢的查询有人越等不及多刷新好几次)等等。

【回复】

ES 内存  GC, cpu  load 等问题
1首先要考虑并发查询的量,如果量非常的大,是很大可能造成CPU和load飙升.
2如果查询量很小,那看看是否存在重型的聚合查询,(基于10亿数据的聚合),又存在一定量的并发,非常非常大的几率造成cpu和load飙升.
3系统的某些参数,也会造成load负载飙高.比如虚拟内存相关的配置.
4linux 系统如果配置的不好,也会出现问题
5ES集群瞬间删除大量(可能是几百个索引或者几百GB)的索引,短时间内io操作频繁,会引起load标高
 
访问限制问题
1高版本已经有权限的控制了

2可以利用linux防火墙,将es,kibana等封起来,只对外暴露一个URL.比如nginx代理服务器

3利用nginx可以对访问的url进行重写,过滤掉一些非法的操作和参数

4也可以修改kibana和es源码进行请求的校验

# 7、【别名】关于按日拆分索引的java实现

需要按日拆分索引去存储文档，有两种实现方式，想咨询下优劣或更好的方式

索引命名方式index-yyyy-MM-dd

第一种是在存储文档前用exists API判断index-yyyy-MM-dd是否存在，没有则创建一个新索引再插入文档。

第二种是创建一个索引模版，并在action.auto_create_index中添加index*，则没有索引的话会直接新建索引。

感觉第一种会有并发问题，而且每次判断也繁琐。第二种过于自由...

想知道有没有什么好的实现方式

【回复】

我们一直用的第二种。模板就是为了解决需要创建一类具有相同结构的索引而存在的。

只要管理好就没啥问题。

按日拆分的索引基本上结构是一致的。

这个需要看查询的时候是否指定了索引中存在的日期字段范围。如果指定了范围并且范围不是太大的话，性能差别可以忽略，这个时候可以用别名。如果没指定的话通过索引名或者范围比较小的别名效果更好。

总的来说，用别名或者用索引名是一个查询范围的问题，更精确的搜索范围效果更好，不过如果查询范围比较大性能也可以接受的话，也没啥大碍，别名更方便管理和使用。

# 8、没有索引数据，ES节点启动候就占用3个G的内存？

软件版本：ES6.5.4
运行环境：
OS：Linux CentOS 7.4
CPU：16C
Mem：32G
ES Heap：16G
 
ES集群搭建完成，启动后，数据节点的堆内存占用就试用了3个G，没有新增其他插件和字典库，这3个G的内存，后续会通过GC回收掉吗？启动是加载了什么会占用3个G?

【回复】
这3G是jvm分配使用的内存，很多应该是临时对象，young gc后就能释放。
你可以通过jstat -gc pid命令查看old区内存使用情况

# 9、scroll search会产生额外一次查询

ES版本：6.3
按照官方文档操作：https://www.elastic.co/guide/e ... ments

发现第一次search是多余的（循环外的：SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);
）

假设分页size是2000，记录数2500；

那循环外第一次search返回2000
循环内第一次返回2000
循环内第二次返回500

第一次的查询是浪费的，请问这个问有解吗？

【回复】

如果是scroll的话，searchRequest需要设scroll参数
 
searchRequest.scroll( TimeValue )
 
才会去执行scroll搜索的，如果不设就是普通检索了。
 
从第二次scroll开始，就不能用searchRequest了，要用SearchScrollRequest，它的最主要的参数是scrollId，new SearchScrollRequest(scrollId)
 
然后每次需要重新做这个SearchScrollRequest传进client，直到结果里的数据list为空，代表符合你query条件的数据已经被完全滚动了

# 10、中文拼音自定义混合搜索的问题

数据里面有  小蜜 小米 小迷  三条数据
我想搜索 小米 会先出现 小蜜 接下来是小米 
我想问下中文拼音混合搜索具体如何测试和搜索  
谢谢大佬

【回复】

拼音和汉字单独定义，搜索的时候，给汉字的权重高一些，拼音的权重低一点
```
{
	"productName": {
		"type": "text",
		"analyzer": "ik_smart",
		"search_analyzer": "ik_smart",
		"fields": {
			"pinyin": {
				"type": "text",
				"analyzer": "ik_pinyin_analyzer",
				"search_analyzer": "ik_pinyin_analyzer"
			}
		}
	}
}
```



